name: CI / Deploy to GHCR & EC2

on:
  push:
    branches:
      - main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PIPELINE OVERVIEW
#
#  unit-tests â”€â”€â”
#               â”œâ”€â”€â–º e2e-tests â”€â”€â–º build-and-push â”€â”€â–º deploy
#  integration- â”˜
#  tests
#
# Production is never touched unless ALL three test gates pass.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GATE 1 â€” Unit Tests
  # Pure functions, no external dependencies, fast feedback.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  unit-tests:
    name: "ðŸ§ª Unit Tests"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Generate Prisma client (for TypeScript types)
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Run unit tests
        run: npm run test:unit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GATE 2 â€” Integration Tests
  # Route handlers and lib modules tested with mocked external dependencies.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  integration-tests:
    name: "ðŸ”— Integration Tests"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

      - name: Run integration tests
        run: npm run test:integration

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GATE 3 â€” E2E Tests
  # Full browser tests against a running Next.js instance backed by a real
  # (ephemeral) PostgreSQL database.  Only runs after Gates 1 & 2 pass.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-tests:
    name: "ðŸŒ E2E Tests"
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: e2etest
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: "postgresql://testuser:testpassword@localhost:5432/e2etest"
      # AUTH_SECRET must be â‰¥32 chars â€” this value is safe for ephemeral CI only
      AUTH_SECRET: "ci-e2e-test-secret-not-for-production-00000"
      # bcrypt hash of the string "ci-test-password" â€” safe for CI only
      ADMIN_PASSWORD_HASH: "$2a$12$ci.placeholder.hash.not.real.xxxxxxxxxxxxxxx"
      NODE_ENV: "test"
      CI: "true"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Generate Prisma client
        run: npx prisma generate

      - name: List generated Prisma files
        run: |
          echo "=== prisma/generated contents ==="
          ls -la prisma/generated/ 2>/dev/null || echo "prisma/generated directory does not exist"
          echo "=== all generated files ==="
          find prisma/generated -type f 2>/dev/null | head -30 || echo "No generated files found"
          echo "=== prisma/generated index file (first 5 lines) ==="
          head -5 prisma/generated/index.ts 2>/dev/null || head -5 prisma/generated/index.js 2>/dev/null || echo "No index file found"
          echo "=== prisma/generated client file (first 5 lines) ==="
          head -5 prisma/generated/client.ts 2>/dev/null || head -5 prisma/generated/client.js 2>/dev/null || echo "No client file found"

      - name: Apply database migrations
        run: npx prisma migrate deploy

      - name: Install Playwright system dependencies
        run: npx playwright install-deps chromium

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start Next.js production server
        # Run in the background; we'll wait for it before launching tests.
        # NODE_ENV must be 'production' â€” next start rejects other values in Next.js 15+.
        run: npm run start > /tmp/nextjs-server.log 2>&1 &
        env:
          NODE_ENV: production

      - name: Wait for server to be ready
        run: |
          echo "Waiting for Next.js to accept connections on port 3000..."
          for i in $(seq 1 60); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:3000/ 2>/dev/null || echo "000")
            if echo "$HTTP_CODE" | grep -qE "^[1-9][0-9][0-9]$"; then
              echo "Server is up (HTTP $HTTP_CODE) âœ“"
              exit 0
            fi
            echo "  attempt $i/60 â€” HTTP $HTTP_CODE, not ready yet, sleeping 2s..."
            if [ "$i" -eq 30 ]; then
              echo "=== Server log at attempt 30 ==="
              tail -20 /tmp/nextjs-server.log || echo "(no log)"
            fi
            sleep 2
          done
          echo "Server did not start in time âœ—"
          echo "=== Last 80 lines of server log ==="
          tail -80 /tmp/nextjs-server.log || echo "(no log)"
          exit 1

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: "http://localhost:3000"

      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BUILD â€” Docker image, only after ALL test gates pass
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:
    name: "ðŸ³ Build & Push to GHCR"
    needs: [unit-tests, integration-tests, e2e-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_ref: ghcr.io/stevenfackley/steveackley-web@${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/stevenfackley/steveackley-web:latest
            ghcr.io/stevenfackley/steveackley-web:sha-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DEPLOY â€” EC2, only after successful Docker build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: "ðŸš€ Deploy to EC2"
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          envs: DATABASE_URL,AUTH_SECRET,ADMIN_PASSWORD_HASH,POSTGRES_PASSWORD,GHCR_TOKEN,GHCR_USER,IMAGE_REF
          script: |
            set -e
            cd ${{ secrets.EC2_APP_DIR }}

            if [ -z "$IMAGE_REF" ]; then
              echo "ERROR: IMAGE_REF is empty"
              exit 1
            fi

            echo "==> Deploying image ref: $IMAGE_REF"

            echo "==> Log in to GHCR"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            echo "==> Pull latest code (compose file, configs)"
            git pull origin main

            echo "==> Removing old .env (prevents Docker Compose $ interpolation)"
            rm -f .env

            echo "==> Writing web.env file for web container"
            ESCAPED_HASH=$(printf '%s' "$ADMIN_PASSWORD_HASH" | sed 's/\$/\$\$/g')
            printf 'DATABASE_URL=%s\nAUTH_SECRET=%s\nADMIN_PASSWORD_HASH=%s\n' \
              "$DATABASE_URL" "$AUTH_SECRET" "$ESCAPED_HASH" > web.env
            chmod 600 web.env

            echo "==> Writing postgres secret file"
            mkdir -p secrets
            printf '%s' "$POSTGRES_PASSWORD" > secrets/postgres_password.txt
            chmod 600 secrets/postgres_password.txt

            echo "==> Verifying web.env file"
            echo "  web.env: $(wc -l < web.env) lines, $(wc -c < web.env) bytes"
            awk -F= '{print "  âœ“ " $1}' web.env
            echo "  secrets/postgres_password.txt: $(wc -c < secrets/postgres_password.txt) bytes"

            echo "==> Ensuring web network exists"
            docker network create web 2>/dev/null || true

            echo "==> Pulling image and restarting"
            IMAGE_REF="$IMAGE_REF" docker compose pull web
            IMAGE_REF="$IMAGE_REF" docker compose up -d --remove-orphans

            echo "==> Waiting for container to start..."
            sleep 15

            echo "==> Container logs (full startup):"
            docker logs steveackley-web 2>&1 || true

            echo "==> Container status:"
            docker ps --filter name=steveackley-web --format "{{.Status}}" || true

            echo "==> DB container status:"
            docker ps --filter name=steveackley-db --format "{{.Status}}" || true

            echo "==> Health check â€” hitting http://localhost:3000/"
            curl -sS -o /tmp/health_response.txt -w "HTTP_STATUS: %{http_code}\n" http://localhost:3000/ 2>&1 || true
            echo "==> Response body (first 500 chars):"
            head -c 500 /tmp/health_response.txt 2>/dev/null || true
            echo ""

            echo "==> Health check â€” hitting http://localhost:3000/admin/login"
            curl -sS -o /dev/null -w "HTTP_STATUS: %{http_code}\n" http://localhost:3000/admin/login 2>&1 || true

            echo "==> Container logs AFTER health check:"
            docker logs steveackley-web --tail 40 2>&1 || true

            echo "==> Pruning old images"
            docker image prune -f

            echo "==> Deploy complete âœ“"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
          IMAGE_REF: ${{ needs.build-and-push.outputs.image_ref }}

      - name: Purge Cloudflare Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            --fail-with-body
          echo "âœ“ Cloudflare cache purged"
