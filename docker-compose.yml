# =============================================================================
# steveackley.org — Production Docker Compose
#
# Sensitive config (DATABASE_URL, AUTH_SECRET, ADMIN_PASSWORD_HASH) is injected
# via .env file, generated by CI/CD from GitHub Secrets.
# Postgres password uses Docker secrets (postgres runs as root, no perm issues).
# =============================================================================

services:
  web:
    image: ghcr.io/stevenfackley/steveackley-web:latest
    build: .                              # Allows local builds with `docker compose build`
    container_name: steveackley-web
    ports:
      - "3000:3000"
    env_file:
      - .env                              # Secrets from CI/CD-generated .env file
    environment:
      # Non-sensitive configuration (safe to commit — these override .env if duplicated)
      NODE_ENV: production
      AUTH_URL: "https://aws.steveackley.org"
      AUTH_TRUST_HOST: "true"
      ADMIN_EMAIL: "stevenfackley@gmail.com"
      NEXT_PUBLIC_LINKEDIN_URL: "https://linkedin.com/in/stevenfackley"
      NEXT_PUBLIC_EMAIL: "stevenfackley@gmail.com"
      NEXT_PUBLIC_P1_OPS_HUB_URL: "https://test.steveackley.org"
      UPLOAD_DIR: /app/uploads
      MAX_UPLOAD_SIZE_MB: "5"
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - web
      - internal

  db:
    image: postgres:16-alpine
    container_name: steveackley-db
    secrets:
      - postgres_password
    environment:
      POSTGRES_DB: steveackleydb
      POSTGRES_USER: steveackley
      # Official postgres image reads password from file (no $ escaping issues)
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U steveackley -d steveackleydb"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      - internal

# Docker secrets — only postgres uses file-based secrets (runs as root)
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt

volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local

networks:
  web:
    external: true
    name: web
  internal:
    driver: bridge
