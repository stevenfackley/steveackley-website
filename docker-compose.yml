# =============================================================================
# steveackley.org — Production Docker Compose
#
# Secrets are stored as files in ./secrets/ (generated by CI/CD from GitHub
# Secrets). Docker mounts them read-only at /run/secrets/<name> inside the
# container. The entrypoint.sh script reads them into env vars at startup.
#
# No more .env file needed in production — GitHub Secrets is the source of truth.
# =============================================================================

services:
  web:
    image: ghcr.io/stevenfackley/steveackley-web:latest
    build: .                              # Allows local builds with `docker compose build`
    container_name: steveackley-web
    ports:
      - "127.0.0.1:3000:3000"
    secrets:
      - database_url
      - auth_secret
      - admin_password_hash
    environment:
      # Non-sensitive configuration (safe to commit)
      NODE_ENV: production
      AUTH_URL: "https://aws.steveackley.org"
      AUTH_TRUST_HOST: "true"
      ADMIN_EMAIL: "stevenfackley@gmail.com"
      NEXT_PUBLIC_LINKEDIN_URL: "https://linkedin.com/in/stevenfackley"
      NEXT_PUBLIC_EMAIL: "stevenfackley@gmail.com"
      NEXT_PUBLIC_P1_OPS_HUB_URL: "https://test.steveackley.org"
      UPLOAD_DIR: /app/uploads
      MAX_UPLOAD_SIZE_MB: "5"
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - web
      - internal

  db:
    image: postgres:16-alpine
    container_name: steveackley-db
    secrets:
      - postgres_password
    environment:
      POSTGRES_DB: steveackleydb
      POSTGRES_USER: steveackley
      # Official postgres image reads password from file (no $ escaping issues)
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U steveackley -d steveackleydb"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      - internal

# Docker secrets — files in ./secrets/ are mounted read-only at /run/secrets/
secrets:
  database_url:
    file: ./secrets/database_url.txt
  auth_secret:
    file: ./secrets/auth_secret.txt
  admin_password_hash:
    file: ./secrets/admin_password_hash.txt
  postgres_password:
    file: ./secrets/postgres_password.txt

volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local

networks:
  web:
    external: true
    name: web
  internal:
    driver: bridge
